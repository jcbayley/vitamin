<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vitamin.plotting &mdash; vitamin 0.3.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> vitamin
          </a>
              <div class="version">
                0.3.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vitamin_start_to_finish.html">Run Your Own Analysis from Start to Finish</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parameters_files.html">Customizing Your Parameters Files</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">vitamin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>vitamin.plotting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vitamin.plotting</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Script containing a suite of plotting-related functions used by vitamin_b</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">gaussian_kde</span><span class="p">,</span> <span class="n">ks_2samp</span><span class="p">,</span> <span class="n">anderson_ksamp</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">dblquad</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="c1">#from ligo.skymap.plot import PPPlot</span>
<span class="kn">import</span> <span class="nn">bilby</span>
<span class="kn">from</span> <span class="nn">universal_divergence</span> <span class="kn">import</span> <span class="n">estimate</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="p">(</span><span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">FormatStrFormatter</span><span class="p">,</span> <span class="n">FixedLocator</span><span class="p">,</span>
                               <span class="n">AutoMinorLocator</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">from</span> <span class="nn">lal</span> <span class="kn">import</span> <span class="n">GreenwichMeanSiderealTime</span>
<span class="c1">#from load_data import load_samples, convert_hour_angle_to_ra</span>

<div class="viewcode-block" id="make_ppplot"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_ppplot">[docs]</a><span class="k">def</span> <span class="nf">make_ppplot</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">truths</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">posterior</span> <span class="o">=</span> <span class="n">post</span>
        <span class="n">res</span><span class="o">.</span><span class="n">search_parameter_keys</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">res</span><span class="o">.</span><span class="n">injection_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">truths</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))}</span>
        <span class="n">res</span><span class="o">.</span><span class="n">priors</span> <span class="o">=</span> <span class="p">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">bilby</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))}</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">bilby</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">make_pp_plot</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">savepath</span><span class="p">)</span></div>


<div class="viewcode-block" id="prune_samples"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.prune_samples">[docs]</a><span class="k">def</span> <span class="nf">prune_samples</span><span class="p">(</span><span class="n">chain_file_loc</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to remove bad likelihood emcee chains </span>
<span class="sd">   </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chain_file_loc: str</span>
<span class="sd">        location of emcee chain file</span>
<span class="sd">    params: dict</span>
<span class="sd">        general run parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    XS: array_like</span>
<span class="sd">        pruned emcee samples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">14000</span>
    <span class="n">nburnin</span> <span class="o">=</span> <span class="mi">4000</span>
    <span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="n">thresh_num</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">ndim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">])</span>
    <span class="n">chain_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">chain_file_loc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">exit_flag</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">while</span> <span class="n">exit_flag</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Iterate over all parameters in chain file</span>
        <span class="n">XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">chains_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chain_file</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_post&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nsteps</span><span class="o">-</span><span class="n">nburnin</span><span class="p">,</span><span class="n">nwalkers</span><span class="p">))</span>
            <span class="n">logL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chain_file</span><span class="p">[</span><span class="s1">&#39;log_like_eval&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nsteps</span><span class="o">-</span><span class="n">nburnin</span><span class="p">,</span><span class="n">nwalkers</span><span class="p">))</span>
            <span class="n">logL_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logL</span><span class="p">)</span>

            <span class="n">XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XS</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">chains_before</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># data starts as (nsteps*nwalkers) x ndim -&gt; 2D</span>
        <span class="n">XS</span> <span class="o">=</span> <span class="n">XS</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>                                     <span class="c1"># now ndim x (nsteps*nwalkers) -&gt; 2D</span>
        <span class="n">XS</span> <span class="o">=</span> <span class="n">XS</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span><span class="n">nwalkers</span><span class="p">,</span><span class="n">nsteps</span><span class="o">-</span><span class="n">nburnin</span><span class="p">)</span>                      <span class="c1"># now ndim x nwalkers x nsteps -&gt; 3D</span>
        <span class="n">XSex</span> <span class="o">=</span> <span class="n">XS</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>        <span class="c1"># take one walker nsteps x ndim -&gt; 2D</span>
        <span class="n">XS</span> <span class="o">=</span> <span class="n">XS</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>                          <span class="c1"># now nsteps x nwalkers x ndim -&gt; 3D</span>

        <span class="c1"># identify good walkers</span>
        <span class="c1"># logL starts off with shape (nsteps*nwalkers) -&gt; 1D</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">logL_max</span> <span class="o">-</span> <span class="n">thresh_num</span>                                <span class="c1"># define log likelihood threshold</span>
        <span class="n">idx_walkers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">logL</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">thresh</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>       <span class="c1"># get the indices of good chains</span>
        <span class="n">Nsamp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_walkers</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nsteps</span><span class="o">-</span><span class="n">nburnin</span><span class="p">)</span>                                 <span class="c1"># redefine total number of good samples </span>

        <span class="c1"># select good walkers</span>
        <span class="n">XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">XS</span><span class="p">[:,</span><span class="n">i</span><span class="p">,:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_walkers</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>     <span class="c1"># just pick out good walkers</span>

        <span class="n">XS</span> <span class="o">=</span> <span class="n">XS</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ndim</span><span class="p">)</span>                                    <span class="c1"># now back to original shape (but different order) (walkers*nstep) x </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#idx = np.random.choice(Nsamp,10000)          # choose 10000 random indices for corner plots</span>
            <span class="k">if</span> <span class="n">Nsamp</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rand_idx_posterior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nsamp</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rand_idx_posterior</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">rand_idx_posterior</span><span class="p">[:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">thresh_num</span><span class="o">+=</span><span class="mi">10</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... increasing threshold value to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">thresh_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># pick out random samples from clean set</span>
    <span class="n">XS</span> <span class="o">=</span> <span class="n">XS</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>                                                  <span class="c1"># select 10000 random samples</span>

    <span class="k">return</span> <span class="n">XS</span></div>

<div class="viewcode-block" id="make_dirs"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_dirs">[docs]</a><span class="k">def</span> <span class="nf">make_dirs</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make directories to store plots. Directories that already exist will be overwritten.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params: dict</span>
<span class="sd">        general run parameters</span>
<span class="sd">    out_dir: str</span>
<span class="sd">        output directory for test plots</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## If file exists, delete it ##</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>    <span class="c1">## Show a message ##</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attention: </span><span class="si">%s</span><span class="s2"> directory not found, making new directory&quot;</span> <span class="o">%</span> <span class="n">out_dir</span><span class="p">)</span>

    <span class="c1">## If file exists, delete it ##</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plotting data directory already exits.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>    <span class="c1">## Show a message ##</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attention: plotting_data_</span><span class="si">%s</span><span class="s2"> directory not found, making new directory ...&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>
        <span class="c1"># setup output directory - if it does not exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory: plotting_data_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/latest&#39;</span> <span class="o">%</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/animations&#39;</span> <span class="o">%</span> <span class="n">out_dir</span><span class="p">)</span>
   
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out_dir</span><span class="o">+</span><span class="s1">&#39;/latest&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">out_dir</span><span class="o">+</span><span class="s1">&#39;/animations&#39;</span><span class="p">))</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="factorial"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.factorial">[docs]</a><span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#base case</span>
       <span class="k">return</span> <span class="n">n</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="k">return</span> <span class="n">n</span><span class="o">*</span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># recursive case</span></div>

<div class="viewcode-block" id="make_plots"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_plots">[docs]</a><span class="k">class</span> <span class="nc">make_plots</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class to generate a suite of testing plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">samples</span><span class="p">,</span><span class="n">rev_x</span><span class="p">,</span><span class="n">pos_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add variables here later if need be</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>       <span class="c1"># general run parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>     <span class="c1"># Bayesian posterior samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rev_x</span> <span class="o">=</span> <span class="n">rev_x</span>         <span class="c1"># pre-generated NN posteriors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_test</span> <span class="o">=</span> <span class="n">pos_test</span>   <span class="c1"># scalar truths of test samples</span>

        <span class="k">def</span> <span class="nf">load_test_set</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">sig_test</span><span class="p">,</span><span class="n">par_test</span><span class="p">,</span><span class="n">y_normscale</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;dynesty1&#39;</span><span class="p">,</span><span class="n">vitamin_pred_made</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; load requested test set</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            model: tensorflow object</span>
<span class="sd">                pre-trained tensorflow neural network</span>
<span class="sd">            sig_test: array_like</span>
<span class="sd">                test signal time series</span>
<span class="sd">            par_test: array_like</span>
<span class="sd">                test signal source parameter values</span>
<span class="sd">            y_normscale: float</span>
<span class="sd">                arbitrary normalization factor to scale time series</span>
<span class="sd">            bounds: dict</span>
<span class="sd">                bounds allowed for GW waveforms</span>
<span class="sd">            sampler: str</span>
<span class="sd">                sampler results to load</span>
<span class="sd">            vitamin_pred_made: bool</span>
<span class="sd">                if True, use pre-generated vitamin predictions</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            VI_pred_all: array_like</span>
<span class="sd">                predictions made by the vitamin box</span>
<span class="sd">            XS_all: array_like</span>
<span class="sd">                predictions made by the Bayesian samplers</span>
<span class="sd">            dt: array_like</span>
<span class="sd">                time to compute posterior predictions </span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;vitamin1&#39;</span> <span class="ow">or</span> <span class="n">sampler</span><span class="o">==</span><span class="s1">&#39;vitamin2&#39;</span><span class="p">:</span>

                <span class="c1"># check if vitamin test posteriors have already been generated</span>
                <span class="k">if</span> <span class="n">vitamin_pred_made</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">vitamin_pred_made</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vitamin_pred_made</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">VI_pred_all</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]):</span>
                    <span class="c1"># The trained inverse model weights can then be used to infer a probability density of solutions given new measurements</span>
                    <span class="n">VI_pred</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span>  <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">par_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sig_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                              <span class="s2">&quot;inverse_model_dir_</span><span class="si">%s</span><span class="s2">/inverse_model.ckpt&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span>
                                              <span class="n">wrmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_modes&#39;</span><span class="p">]))</span>

                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    # convert RA to hour angle for test set validation cost if both ra and geo time present</span>
<span class="sd">                    if np.isin(&#39;ra&#39;, params[&#39;inf_pars&#39;]) and  np.isin(&#39;geocent_time&#39;, params[&#39;inf_pars&#39;]):</span>
<span class="sd">                        # get geocenttime index</span>
<span class="sd">                        for k_idx,k in enumerate(params[&#39;inf_pars&#39;]):</span>
<span class="sd">                            if k == &#39;geocent_time&#39;:</span>
<span class="sd">                                geo_idx = k_idx</span>
<span class="sd">                            elif k == &#39;ra&#39;:</span>
<span class="sd">                                ra_idx = k_idx</span>

<span class="sd">                        # unnormalize and get gps time</span>
<span class="sd">                        VI_pred[:,ra_idx] = (VI_pred[:,ra_idx] * (bounds[&#39;ra_max&#39;] - bounds[&#39;ra_min&#39;])) + bounds[&#39;ra_min&#39;]   </span>

<span class="sd">                        gps_time_arr = (VI_pred[:,geo_idx] * (bounds[&#39;geocent_time_max&#39;] - bounds[&#39;geocent_time_min&#39;])) + bounds[&#39;geocent_time_min&#39;]</span>
<span class="sd">                        # convert to RA</span>
<span class="sd">                        # Iterate over all training samples and convert to hour angle</span>
<span class="sd">                        for k in range(VI_pred.shape[0]):</span>
<span class="sd">#                            VI_pred[k,ra_idx]=np.mod(GreenwichMeanSiderealTime(float(params[&#39;ref_geocent_time&#39;]+gps_time_arr[k]))-VI_pred[k,ra_idx], 2.0*np.pi)</span>
<span class="sd">                            VI_pred[k,ra_idx]=np.mod(GreenwichMeanSiderealTime(params[&#39;ref_geocent_time&#39;])-VI_pred[k,ra_idx], 2.0*np.pi)</span>
<span class="sd">                        # normalize</span>
<span class="sd">                        VI_pred[:,ra_idx]=(VI_pred[:,ra_idx] - bounds[&#39;ra_min&#39;]) / (bounds[&#39;ra_max&#39;] - bounds[&#39;ra_min&#39;])</span>
<span class="sd">                    &quot;&quot;&quot;</span>                    

                    <span class="n">VI_pred_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VI_pred</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generated vitamin preds </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])))</span>

                <span class="n">VI_pred_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VI_pred_all</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">VI_pred_all</span><span class="p">,</span> <span class="n">dt</span>


            <span class="c1"># load up the posterior samples (if they exist)</span>
            <span class="c1"># load generated samples back in</span>
            <span class="n">post_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># choose directory with lowest number of total finished posteriors</span>
            <span class="n">num_finished_post</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e8</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;vitamin&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">input_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s%d</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pe_dir&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">input_dir</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">dataLocations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">input_dir</span><span class="p">]</span>

                    <span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataLocations</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>      
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_finished_post</span><span class="p">:</span>
                        <span class="n">sampler_loc</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">num_finished_post</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>

            <span class="n">dataLocations_try</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pe_dir&#39;</span><span class="p">],</span><span class="n">sampler_loc</span><span class="p">)</span>
            
            <span class="n">dataLocations</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pe_dir&#39;</span><span class="p">],</span><span class="n">sampler</span><span class="p">)</span>

            <span class="c1">#for i,filename in enumerate(glob.glob(dataLocations[0])):</span>
            <span class="n">i_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">i_idx_use</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">i_idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]:</span>

<span class="c1">#                filename_try = &#39;%s/%s_%d.h5py&#39; % (dataLocations_try,self.params[&#39;bilby_results_label&#39;],i)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.h5py&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataLocations</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_results_label&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">samp_idx_inner</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">inner_file_existance</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">samp_idx_inner</span> <span class="o">==</span> <span class="n">sampler</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">inner_file_existance</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">inner_file_existance</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>

                    <span class="n">dataLocations_inner</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pe_dir&#39;</span><span class="p">],</span><span class="n">samp_idx_inner</span><span class="o">+</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
                    <span class="n">filename_inner</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.h5py&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataLocations_inner</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_results_label&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span>
                    <span class="c1"># If file does not exist, skip to next file</span>
                    <span class="n">inner_file_existance</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename_inner</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inner_file_existance</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">inner_file_existance</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
<span class="c1">#                    print(&#39;File does not exist for one of the samplers&#39;)</span>
                    <span class="k">continue</span>

                <span class="c1"># If file does not exist, skip to next file</span>
<span class="c1">#                try:</span>
<span class="c1">#                    h5py.File(filename_try, &#39;r&#39;)</span>
<span class="c1">#                except Exception as e:</span>
<span class="c1">#                    i+=1</span>
<span class="c1">#                    continue</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="s1">&#39;runtime&#39;</span><span class="p">]))</span>

                <span class="n">post_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sampler</span> <span class="o">==</span> <span class="s1">&#39;emcee1&#39;</span><span class="p">:</span>
                    <span class="n">emcee_pruned_samples</span> <span class="o">=</span> <span class="n">prune_samples</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">data_temp</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">q_idx</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">]):</span>
                     <span class="n">p</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39;_post&#39;</span>
                     <span class="n">par_min</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39;_min&#39;</span>
                     <span class="n">par_max</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="s1">&#39;_max&#39;</span>
                     <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;psi_post&#39;</span><span class="p">:</span>
                         <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">sampler</span> <span class="o">==</span> <span class="s1">&#39;emcee1&#39;</span><span class="p">:</span>
                         <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">emcee_pruned_samples</span><span class="p">[:,</span><span class="n">q_idx</span><span class="p">]</span>
                     <span class="k">else</span><span class="p">:</span>
                         <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">p</span><span class="p">][:]</span>
                     <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;geocent_time_post&#39;</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;geocent_time_post_with_cut&#39;</span><span class="p">:</span>
                         <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ref_geocent_time&#39;</span><span class="p">]</span>
                     <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="n">par_min</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="n">par_max</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="n">par_min</span><span class="p">])</span>
                     <span class="n">Nsamp</span> <span class="o">=</span> <span class="n">data_temp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                     <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">data_temp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">XS</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">rand_idx_posterior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">XS</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rand_idx_posterior</span><span class="p">)</span>
                <span class="n">rand_idx_posterior</span> <span class="o">=</span> <span class="n">rand_idx_posterior</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">i_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">XS_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">XS</span><span class="p">[</span><span class="n">rand_idx_posterior</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1">#XS_all = np.expand_dims(XS[:self.params[&#39;n_samples&#39;],:], axis=0)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># save all posteriors in array</span>
                    <span class="n">max_allow_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">XS_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">XS</span><span class="p">[</span><span class="n">rand_idx_posterior</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">XS_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">XS_all</span><span class="p">[:,:</span><span class="n">max_allow_idx</span><span class="p">,:],</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">XS</span><span class="p">[</span><span class="n">rand_idx_posterior</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,:</span><span class="n">max_allow_idx</span><span class="p">,:]))</span>
                    <span class="c1">#XS_all = np.vstack((XS_all[:,:max_allow_idx,:],np.expand_dims(XS[:self.params[&#39;n_samples&#39;],:], axis=0)[:,:max_allow_idx,:]))</span>

                <span class="n">i_idx_use</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">i_idx</span><span class="o">+=</span><span class="mi">1</span>

            <span class="c1"># save time per sample</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dt</span><span class="p">)])</span>

            <span class="k">return</span> <span class="n">XS_all</span><span class="p">,</span> <span class="n">dt</span>

        <span class="k">def</span> <span class="nf">confidence_bd</span><span class="p">(</span><span class="n">samp_array</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; compute confidence bounds for a given array</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            samp_array: array_like</span>
<span class="sd">                posterior samples</span>
<span class="sd"> </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            list:</span>
<span class="sd">                lower and upper bounds of the confidence interval</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">cf_bd_sum_lidx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cf_bd_sum_ridx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cf_bd_sum_left</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cf_bd_sum_right</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cf_perc</span> <span class="o">=</span> <span class="mf">0.05</span>

            <span class="n">cf_bd_sum_lidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">samp_array</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samp_array</span><span class="p">)</span><span class="o">*</span><span class="n">cf_perc</span><span class="p">)]</span>
            <span class="n">cf_bd_sum_ridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">samp_array</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samp_array</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cf_perc</span><span class="p">))]</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">cf_bd_sum_lidx</span><span class="p">,</span> <span class="n">cf_bd_sum_ridx</span><span class="p">]</span>

        <span class="c1"># Store above declared functions to be used later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_test_set</span> <span class="o">=</span> <span class="n">load_test_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_bd</span> <span class="o">=</span> <span class="n">confidence_bd</span>

<div class="viewcode-block" id="make_plots.pp_plot"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_plots.pp_plot">[docs]</a>    <span class="k">def</span> <span class="nf">pp_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">truth</span><span class="p">,</span><span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generates the pp plot data given samples and truth values</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        truth: float</span>
<span class="sd">            true scalar value of source parameter</span>
<span class="sd">        samples: array_like</span>
<span class="sd">            posterior samples of source parameter</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        r: float</span>
<span class="sd">            pp value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Nsamp</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">samples</span><span class="o">&gt;</span><span class="n">truth</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="make_plots.plot_pp"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_plots.plot_pp">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">sig_test</span><span class="p">,</span> <span class="n">par_test</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">inf_ol_idx</span><span class="p">,</span> <span class="n">bilby_ol_idx</span><span class="p">,</span> <span class="n">bilby_samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; make p-p plots using in-house methods</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model: tensorflow object</span>
<span class="sd">            pre-trained tensorflow neural network model</span>
<span class="sd">        sig_test: array_like</span>
<span class="sd">            array of test time series</span>
<span class="sd">        par_test: array_like</span>
<span class="sd">            array of test time series source parameters</span>
<span class="sd">            </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normscales</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y_normscale&#39;</span><span class="p">]</span>

        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Npp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span> <span class="c1"># number of test GW waveforms to use to calculate PP plot</span>
        <span class="n">ndim_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ndata&#39;</span><span class="p">]</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Create dataset to save PP results for later plotting</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/pp_plot_data.h5&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create dataset to save PP results for later plotting</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/pp_plot_data.h5&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/pp_plot_data.h5&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
   
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;load_plot_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">])))</span> 
            <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Npp</span><span class="p">):</span>

                <span class="c1"># generate Vitamin samples</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sig_test</span><span class="p">[</span><span class="n">cnt</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                 <span class="c1"># The trained inverse model weights can then be used to infer a probability density of solutions </span>
<span class="c1">#given new measurements</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gen_samples</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ramp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]))</span>
                
                <span class="n">true_XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">inf_ol_idx</span><span class="p">)])</span>
                <span class="n">true_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inf_ol_idx</span><span class="p">)])</span>
                <span class="n">ol_pars</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cnt_rm_inf</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">inf_idx</span> <span class="ow">in</span> <span class="n">inf_ol_idx</span><span class="p">:</span>
                    <span class="n">inf_par</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">][</span><span class="n">inf_idx</span><span class="p">]</span>
                    <span class="n">true_XS</span><span class="p">[:,</span><span class="n">cnt_rm_inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">inf_idx</span><span class="p">]</span> <span class="c1"># (samples[:,inf_idx] * (bounds[inf_par+&#39;_max&#39;] - bounds[inf_par+&#39;_min&#39;])) + bounds[inf_par+&#39;_min&#39;]</span>
                    <span class="n">true_x</span><span class="p">[</span><span class="n">cnt_rm_inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_test</span><span class="p">[</span><span class="n">cnt</span><span class="p">,</span><span class="n">inf_idx</span><span class="p">]</span>
                    <span class="n">ol_pars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inf_par</span><span class="p">)</span>
                    <span class="n">cnt_rm_inf</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Apply mask</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">true_XS</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span>
                <span class="n">sampset_1</span> <span class="o">=</span> <span class="n">x</span>   
                <span class="n">del_cnt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># iterate over each sample   during inference training</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampset_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># iterate over each parameter</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]):</span>
                        <span class="c1"># if sample out of range, delete the sample                                              the y data (size changes by factor of  n_filter/(2**n_redsteps) )</span>
                        <span class="k">if</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">del_cnt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   
                            <span class="n">del_cnt</span><span class="o">-=</span><span class="mi">1</span>
                            <span class="k">break</span>
                        <span class="c1"># check m1 &gt; m2</span>
                        <span class="k">elif</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_1&#39;</span> <span class="ow">or</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_2&#39;</span><span class="p">:</span>
                            <span class="n">m1_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mass_1&#39;</span><span class="p">)</span>
                            <span class="n">m2_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mass_2&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">m1_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">m2_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">del_cnt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">del_cnt</span><span class="o">-=</span><span class="mi">1</span>
                                <span class="k">break</span>    
                    <span class="n">del_cnt</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">])):</span>
                    <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">pp</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_plot</span><span class="p">(</span><span class="n">true_x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">,:])</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Computed param </span><span class="si">%d</span><span class="s1"> p-p plot iteration </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">Npp</span><span class="p">)))</span>
                    <span class="nb">print</span><span class="p">()</span>

            <span class="c1"># Save VItamin pp curves</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;vitamin_pp_data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pp</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pp</span> <span class="o">=</span> <span class="n">hf</span><span class="p">[</span><span class="s1">&#39;vitamin_pp_data&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Loaded VItamin pp curves&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="n">confidence_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># plot the pp plot</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">])):</span>        
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\textrm{</span><span class="si">%s</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;figure_sampler_names&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]),</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1">#confidence_pp = np.zeros((len(self.params[&#39;samplers&#39;])-1,int(self.params[&#39;r&#39;])+2))</span>
        <span class="c1"># make bilby p-p plots</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        samplers = self.params[&#39;samplers&#39;]</span>
<span class="sd">        CB_color_cycle=[&#39;blue&#39;,&#39;green&#39;,&#39;purple&#39;,&#39;orange&#39;]</span>

<span class="sd">        for i in range(len(self.params[&#39;samplers&#39;])):</span>
<span class="sd">            if samplers[i] == &#39;vitamin&#39;: continue</span>

<span class="sd">            if self.params[&#39;load_plot_data&#39;] == False:</span>
<span class="sd">                # load bilby sampler samples</span>
<span class="sd">                #samples,time = self.load_test_set(model,sig_test,par_test,normscales,bounds,sampler=samplers[i]+&#39;1&#39;)</span>
<span class="sd">                samples = bilby_samples[:,i,:]#load_samples(self.params, samplers[i], pp_plot=True)</span>
<span class="sd">                true_XS = np.zeros([samples.shape[0],samples.shape[1],len(bilby_ol_idx)])</span>
<span class="sd">                true_x = np.zeros([samples.shape[0],len(bilby_ol_idx)])</span>
<span class="sd">                ol_pars = []; cnt_rm_inf = 0</span>
<span class="sd">                for inf_idx,bilby_idx in zip(inf_ol_idx,bilby_ol_idx):</span>
<span class="sd">                    bilby_par = params[&#39;bilby_pars&#39;][bilby_idx]</span>
<span class="sd">                    inf_par = params[&#39;inf_pars&#39;][inf_idx]</span>
<span class="sd">                    true_XS[:,:,cnt_rm_inf] = samples[:,:,bilby_idx] #(samples[:,:,bilby_idx] * (bounds[bilby_par+&#39;_max&#39;] - bounds[bilby_par+&#39;_min&#39;])) + bounds[bilby_par+&#39;_min&#39;]</span>
<span class="sd">                    true_x[:,cnt_rm_inf] = par_test[:,inf_idx]</span>
<span class="sd">                    ol_pars.append(bilby_par)</span>
<span class="sd">                    cnt_rm_inf += 1</span>
<span class="sd">                samples = true_XS</span>

<span class="sd">                if samples.shape[0] == self.params[&#39;r&#39;]:</span>
<span class="sd">                    samples = samples[:,:,-self.params[&#39;n_samples&#39;]:]</span>
<span class="sd">                else:</span>
<span class="sd">                    samples = samples[:self.params[&#39;n_samples&#39;],:]</span>

<span class="sd">            for j in range(len(self.params[&#39;bilby_pars&#39;])):</span>
<span class="sd">                pp_bilby = np.zeros((self.params[&#39;r&#39;])+2)</span>
<span class="sd">                pp_bilby[0] = 0.0</span>
<span class="sd">                pp_bilby[1] = 1.0</span>
<span class="sd">                if self.params[&#39;load_plot_data&#39;] == False:</span>
<span class="sd">                    for cnt in range(self.params[&#39;r&#39;]):</span>
<span class="sd">                        pp_bilby[cnt+2] = self.pp_plot(true_x[cnt, j], samples[cnt,:,j])</span>
<span class="sd">                        print()</span>
<span class="sd">                        print(&#39;... Computed %s, param %d p-p plot iteration %d/%d&#39; % (samplers[i],j,int(cnt)+1,int(self.params[&#39;r&#39;])))</span>
<span class="sd">                        print()</span>
<span class="sd">                    hf.create_dataset(&#39;%s_param%d_pp&#39; % (samplers[i],j), data=pp_bilby)           </span>
<span class="sd">                else:</span>
<span class="sd">                    pp_bilby = hf[&#39;%s_param%d_pp&#39; % (samplers[i],j)]</span>
<span class="sd">                    print()</span>
<span class="sd">                    print(&#39;... Loaded Bilby sampler pp curve&#39;)</span>
<span class="sd">                    print()</span>
<span class="sd">                # plot bilby sampler results</span>
<span class="sd">                if j == 0:</span>
<span class="sd">                    axis.plot(np.arange((self.params[&#39;r&#39;])+2)/((self.params[&#39;r&#39;])+1.0),np.sort(pp_bilby),&#39;-&#39;,color=CB_color_cycle[i-1],linewidth=1,label=r&#39;$\textrm{%s}$&#39; % self.params[&#39;figure_sampler_names&#39;][i],alpha=0.5)</span>
<span class="sd">                else:</span>
<span class="sd">                    axis.plot(np.arange((self.params[&#39;r&#39;])+2)/((self.params[&#39;r&#39;])+1.0),np.sort(pp_bilby),&#39;-&#39;,color=CB_color_cycle[i-1],linewidth=1,alpha=0.5)</span>

<span class="sd">            confidence_pp[i-1,:] = np.sort(pp_bilby)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="c1"># Remove whitespace on x-axis in all plots</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--k&#39;</span><span class="p">)</span>
        <span class="n">conf_color_wheel</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#D8D8D8&#39;</span><span class="p">,</span><span class="s1">&#39;#A4A4A4&#39;</span><span class="p">,</span><span class="s1">&#39;#6E6E6E&#39;</span><span class="p">]</span>
        <span class="n">confidence</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">])</span>

        
        <span class="c1"># Add credibility interals</span>
        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">confidence</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">confidence</span><span class="p">))):</span>
            <span class="n">edge_of_bound</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">edge_of_bound</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x_values</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">edge_of_bound</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x_values</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
            <span class="c1"># The binomial point percent function doesn&#39;t always return 0 @ 0,</span>
            <span class="c1"># so set those bounds explicitly to be sure</span>
            <span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">upper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">conf_color_wheel</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#axis.set_ylabel(r&#39;$\textrm{Empirical Cumulative Distribution}$&#39;,fontsize=14)</span>
        <span class="c1">#axis.set_xlabel(r&#39;$\textrm{Theoretical Cumulative Distribution}$&#39;,fontsize=14)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\textrm{Fraction of events within the Credible Interval}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\textrm{Probability within the Credible Interval}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="c1">#plt.axis(&#39;scaled&#39;)</span>
        <span class="n">leg</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1">#fig.savefig(&#39;%s/pp_plot_%04d.png&#39; % (self.params[&#39;plot_dir&#39;],i_epoch),dpi=360)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/latest_pp_plot.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Saved pp plot to -&gt; </span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/latest_pp_plot.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="make_plots.plot_loss"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_plots.plot_loss">[docs]</a>    <span class="k">def</span> <span class="nf">plot_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Regenerate previously made loss plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Load old plot data</span>
        <span class="n">plotdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;inverse_model_dir_</span><span class="si">%s</span><span class="s2">/loss_data.txt&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>

        <span class="c1"># Make loss plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">xvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;report_interval&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Recon}</span><span class="s1">(L)$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{KL}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Total}</span><span class="s1">(H)$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">3</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">4</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[:,</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">3e3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xvec</span><span class="p">)])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span><span class="mi">15</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Iteration}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm</span><span class="si">{Cost}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/cost_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Saved cost unzoomed plot to -&gt; </span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/cost_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)[</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotdata</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):,</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/cost_zoom_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Saved cost zoomed plot to -&gt; </span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/cost_zoom_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="make_plots.gen_kl_plots"><a class="viewcode-back" href="../../vitamin.html#vitamin.plotting.make_plots.gen_kl_plots">[docs]</a>    <span class="k">def</span> <span class="nf">gen_kl_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">sig_test</span><span class="p">,</span><span class="n">par_test</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">inf_ol_idx</span><span class="p">,</span><span class="n">bilby_ol_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Make kl corner histogram plots.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model: tensorflow object</span>
<span class="sd">            pre-trained tensorflow model</span>
<span class="sd">        sig_test: array_like</span>
<span class="sd">            test sample time series</span>
<span class="sd">        par_test: array_like</span>
<span class="sd">            test sample source parameter values</span>
<span class="sd">        normscales: float</span>
<span class="sd">            arbitrary normalization factor for time series</span>
<span class="sd">        bounds: dict</span>
<span class="sd">            allowed bounds for GW waveform source parameters</span>
<span class="sd">        snrs_test: array_like</span>
<span class="sd">            Optimal SNR values for every test sample</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">extract_correct_sample_idx</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">inf_ol_idx</span><span class="p">):</span>
            <span class="n">true_XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">inf_ol_idx</span><span class="p">)])</span>
            <span class="n">cnt_rm_inf</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">inf_idx</span> <span class="ow">in</span> <span class="n">inf_ol_idx</span><span class="p">:</span>
                <span class="n">inf_par</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">][</span><span class="n">inf_idx</span><span class="p">]</span>
                <span class="n">true_XS</span><span class="p">[:,</span><span class="n">cnt_rm_inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">inf_idx</span><span class="p">]</span> <span class="c1"># (samples[:,inf_idx] * (bounds[inf_par+&#39;_max&#39;] - bounds[inf_par+&#39;_min&#39;])) + bounds[inf_par+&#39;_min&#39;]</span>
                <span class="n">cnt_rm_inf</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Apply mask</span>
            <span class="n">true_XS</span> <span class="o">=</span> <span class="n">true_XS</span><span class="o">.</span><span class="n">T</span>
            <span class="n">sampset_1</span> <span class="o">=</span> <span class="n">true_XS</span>
            <span class="n">del_cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># iterate over each sample   during inference training</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sampset_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1"># iterate over each parameter</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]):</span>
                    <span class="c1"># if sample out of range, delete the sample                                              the y data (size changes by factor of  n_filter/(2**n_redsteps) )</span>
                    <span class="k">if</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">true_XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">true_XS</span><span class="p">,</span><span class="n">del_cnt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">del_cnt</span><span class="o">-=</span><span class="mi">1</span>
                        <span class="k">break</span>
                    <span class="c1"># check m1 &gt; m2</span>
                    <span class="k">elif</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_1&#39;</span> <span class="ow">or</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_2&#39;</span><span class="p">:</span>
                        <span class="n">m1_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mass_1&#39;</span><span class="p">)</span>
                        <span class="n">m2_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mass_2&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">m1_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">m2_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">true_XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">true_XS</span><span class="p">,</span><span class="n">del_cnt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">del_cnt</span><span class="o">-=</span><span class="mi">1</span>
                            <span class="k">break</span>
            <span class="c1"># transpose</span>
            <span class="n">true_XS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">inf_ol_idx</span><span class="p">)])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">true_XS</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">true_XS</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampset_1</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">return</span> <span class="n">true_XS</span>

        <span class="k">def</span> <span class="nf">compute_kl</span><span class="p">(</span><span class="n">sampset_1</span><span class="p">,</span><span class="n">sampset_2</span><span class="p">,</span><span class="n">samplers</span><span class="p">,</span><span class="n">one_D</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Compute KL for one test case.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Remove samples outside of the prior mass distribution           </span>
            <span class="n">cur_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]</span>
            
            <span class="c1"># Iterate over parameters and remove samples outside of prior</span>
            <span class="k">if</span> <span class="n">samplers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vitamin1&#39;</span> <span class="ow">or</span> <span class="n">samplers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vitamin2&#39;</span><span class="p">:</span>

                <span class="c1"># Apply mask</span>
                <span class="n">sampset_1</span> <span class="o">=</span> <span class="n">sampset_1</span><span class="o">.</span><span class="n">T</span>
                <span class="n">sampset_2</span> <span class="o">=</span> <span class="n">sampset_2</span><span class="o">.</span><span class="n">T</span>
                <span class="n">set1</span> <span class="o">=</span> <span class="n">sampset_1</span>
                <span class="n">set2</span> <span class="o">=</span> <span class="n">sampset_2</span>
                <span class="n">del_cnt_set1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">del_cnt_set2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">params_to_infer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                    <span class="c1"># iterate over each parameter in first set</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params_to_infer</span><span class="p">):</span>
                        <span class="c1"># if sample out of range, delete the sample</span>
                        <span class="k">if</span> <span class="n">set1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">set1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">sampset_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sampset_1</span><span class="p">,</span><span class="n">del_cnt_set1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">del_cnt_set1</span><span class="o">-=</span><span class="mi">1</span>
                            <span class="k">break</span>
                        <span class="c1"># check m1 &gt; m2</span>
                        <span class="k">elif</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_1&#39;</span> <span class="ow">or</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_2&#39;</span><span class="p">:</span>
                            <span class="n">m1_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">params_to_infer</span><span class="o">==</span><span class="s1">&#39;mass_1&#39;</span><span class="p">)</span>
                            <span class="n">m2_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">params_to_infer</span><span class="o">==</span><span class="s1">&#39;mass_2&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">set1</span><span class="p">[</span><span class="n">m1_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">set1</span><span class="p">[</span><span class="n">m2_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">sampset_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sampset_1</span><span class="p">,</span><span class="n">del_cnt_set1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">del_cnt_set1</span><span class="o">-=</span><span class="mi">1</span>
                                <span class="k">break</span>

                    <span class="n">del_cnt_set1</span><span class="o">+=</span><span class="mi">1</span>

                <span class="c1"># iterate over each sample</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">set2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                    <span class="c1"># iterate over each parameter in second set</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params_to_infer</span><span class="p">):</span>
                        <span class="c1"># if sample out of range, delete the sample</span>
                        <span class="k">if</span> <span class="n">set2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">set2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">sampset_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sampset_2</span><span class="p">,</span><span class="n">del_cnt_set2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">del_cnt_set2</span><span class="o">-=</span><span class="mi">1</span>
                            <span class="k">break</span>
                        <span class="c1"># check m1 &gt; m2</span>
                        <span class="k">elif</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_1&#39;</span> <span class="ow">or</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;mass_2&#39;</span><span class="p">:</span>
                            <span class="n">m1_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">params_to_infer</span><span class="o">==</span><span class="s1">&#39;mass_1&#39;</span><span class="p">)</span>
                            <span class="n">m2_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">params_to_infer</span><span class="o">==</span><span class="s1">&#39;mass_2&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">set2</span><span class="p">[</span><span class="n">m1_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">set2</span><span class="p">[</span><span class="n">m2_idx</span><span class="p">,</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">sampset_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sampset_2</span><span class="p">,</span><span class="n">del_cnt_set2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">del_cnt_set2</span><span class="o">-=</span><span class="mi">1</span>
                                <span class="k">break</span>

                    <span class="n">del_cnt_set2</span><span class="o">+=</span><span class="mi">1</span>

                <span class="n">del_final_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">del_cnt_set1</span><span class="p">,</span><span class="n">del_cnt_set2</span><span class="p">])</span>
                <span class="n">set1</span> <span class="o">=</span> <span class="n">sampset_1</span><span class="p">[:,:</span><span class="n">del_final_idx</span><span class="p">]</span>
                <span class="n">set2</span> <span class="o">=</span> <span class="n">sampset_2</span><span class="p">[:,:</span><span class="n">del_final_idx</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">set1</span> <span class="o">=</span> <span class="n">sampset_1</span><span class="o">.</span><span class="n">T</span>
                <span class="n">set2</span> <span class="o">=</span> <span class="n">sampset_2</span><span class="o">.</span><span class="n">T</span>
      
            <span class="c1"># Iterate over number of randomized sample slices</span>
            <span class="n">SMALL_CONSTANT</span> <span class="o">=</span> <span class="mf">1e-162</span> <span class="c1"># 1e-4 works best for some reason</span>
            <span class="k">def</span> <span class="nf">my_kde_bandwidth</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

                <span class="sd">&quot;&quot;&quot;We use Scott&#39;s Rule, multiplied by a constant factor.&quot;&quot;&quot;</span>

                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">d</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">*</span> <span class="n">fac</span>
            <span class="k">if</span> <span class="n">one_D</span><span class="p">:</span>
                <span class="n">kl_result_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">])))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inf_pars&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;gen_indi_KLs&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">bw_method</span><span class="o">=</span><span class="n">my_kde_bandwidth</span><span class="p">)</span><span class="c1">#&#39;scott&#39;) # 7.5e0 works best ... don&#39;t know why. Hope it&#39;s not over-smoothing results.</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">set2</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">bw_method</span><span class="o">=</span><span class="n">my_kde_bandwidth</span><span class="p">)</span><span class="c1">#&#39;scott&#39;)#&#39;silverman&#39;) # 7.5e0 works best ... don&#39;t know why.   </span>
                        <span class="c1"># Compute KL Divergence</span>
                        <span class="n">log_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">p</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">r</span><span class="p">])</span><span class="o">+</span><span class="n">SMALL_CONSTANT</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">r</span><span class="p">])</span><span class="o">+</span><span class="n">SMALL_CONSTANT</span><span class="p">))</span>
                        <span class="n">kl_result</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">set1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_diff</span><span class="p">)</span>

                        <span class="c1"># compute symetric kl</span>
                        <span class="n">anti_log_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">q</span><span class="p">(</span><span class="n">set2</span><span class="p">[</span><span class="n">r</span><span class="p">])</span><span class="o">+</span><span class="n">SMALL_CONSTANT</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">set2</span><span class="p">[</span><span class="n">r</span><span class="p">])</span><span class="o">+</span><span class="n">SMALL_CONSTANT</span><span class="p">))</span>
                        <span class="n">anti_kl_result</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">set1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">anti_log_diff</span><span class="p">)</span>
                        <span class="n">kl_result_all</span><span class="p">[:,</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_result</span> <span class="o">+</span> <span class="n">anti_kl_result</span>
<span class="c1">#                        kl_result = estimate(np.expand_dims(set1[r],1),np.expand_dims(set2[r],1))</span>
<span class="c1">#                        kl_result_all[:,r] = kl_result </span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kl_result_all</span><span class="p">[:,</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>   

                <span class="k">return</span> <span class="n">kl_result_all</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="n">kl_result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">set1</span> <span class="o">=</span> <span class="n">set1</span><span class="o">.</span><span class="n">T</span>
                <span class="n">set2</span> <span class="o">=</span> <span class="n">set2</span><span class="o">.</span><span class="n">T</span>
                <span class="c1">#for kl_idx in range(10):</span>
                <span class="n">rand_idx_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rand_idx_kl</span><span class="p">)</span>
                <span class="n">rand_idx_kl</span> <span class="o">=</span> <span class="n">rand_idx_kl</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
                <span class="n">rand_idx_kl_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">rand_idx_kl_2</span><span class="p">)</span>
                <span class="n">rand_idx_kl_2</span> <span class="o">=</span> <span class="n">rand_idx_kl_2</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
                <span class="n">kl_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">estimate</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">rand_idx_kl</span><span class="p">,:],</span><span class="n">set2</span><span class="p">[</span><span class="n">rand_idx_kl_2</span><span class="p">,:],</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">estimate</span><span class="p">(</span><span class="n">set2</span><span class="p">[</span><span class="n">rand_idx_kl_2</span><span class="p">,:],</span><span class="n">set1</span><span class="p">[</span><span class="n">rand_idx_kl</span><span class="p">,:],</span><span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
                
                <span class="n">kl_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">kl_result</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">kl_result</span>

                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                # TODO: comment this out when not doing dynesty kl with itself. Use above expression instead.</span>
<span class="sd">                kl_result_mean = []</span>
<span class="sd">                kl_result_std = []</span>
<span class="sd">                set1 = set1.T</span>
<span class="sd">                set2 = set2.T</span>
<span class="sd">                for kl_idx in range(10):</span>
<span class="sd">                    rand_idx_kl = np.random.choice(np.linspace(0,set1.shape[0]-1,dtype=np.int),size=100)</span>
<span class="sd">                    rand_idx_kl_2 = np.random.choice(np.linspace(0,set2.shape[0]-1,dtype=np.int),size=100)</span>
<span class="sd">                    new_kl = estimate(set1[rand_idx_kl,:],set2[rand_idx_kl_2,:]) + estimate(set2[rand_idx_kl_2,:],set1[rand_idx_kl,:])</span>
<span class="sd">                    kl_result_mean.append(new_kl)</span>
<span class="sd">                    kl_result_std.append(new_kl**2)</span>
<span class="sd">                kl_result_mean = np.mean(kl_result_mean)</span>
<span class="sd">                kl_result_std = np.sqrt(np.mean(kl_result_std))</span>
<span class="sd"> </span>
<span class="sd">                return kl_result_std, kl_result_mean</span>
<span class="sd">                &quot;&quot;&quot;</span>   

        <span class="c1"># Define variables </span>
        <span class="n">usesamps</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">]</span>
        <span class="n">samplers</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">]</span>
        <span class="n">fig_samplers</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;figure_sampler_names&#39;</span><span class="p">]</span>
        <span class="n">indi_fig_kl</span><span class="p">,</span> <span class="p">((</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">),</span> <span class="p">(</span><span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">),</span> <span class="p">(</span><span class="n">ax7</span><span class="p">,</span> <span class="n">ax8</span><span class="p">,</span> <span class="n">ax9</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  
        <span class="n">indi_axis_kl</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">,</span><span class="n">ax7</span><span class="p">,</span><span class="n">ax8</span><span class="p">,</span><span class="n">ax9</span><span class="p">]</span>
      
        <span class="c1"># Compute kl divergence on all test cases with preds vs. benchmark</span>
        <span class="c1"># Iterate over samplers</span>
        <span class="n">tmp_idx</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">usesamps</span><span class="p">)</span>
        <span class="n">print_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">runtime</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">CB_color_cycle</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;#a65628&#39;</span><span class="p">,</span> <span class="s1">&#39;#984ea3&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;#e41a1c&#39;</span><span class="p">,</span> <span class="s1">&#39;#dede00&#39;</span><span class="p">,</span> 
                  <span class="s1">&#39;#004d40&#39;</span><span class="p">,</span><span class="s1">&#39;#d81b60&#39;</span><span class="p">,</span><span class="s1">&#39;#1e88e5&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;#ffc107&#39;</span><span class="p">,</span><span class="s1">&#39;#1aff1a&#39;</span><span class="p">,</span><span class="s1">&#39;#377eb8&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;#fefe62&#39;</span><span class="p">,</span><span class="s1">&#39;#d35fb7&#39;</span><span class="p">,</span><span class="s1">&#39;#dc3220&#39;</span><span class="p">]</span>
        <span class="n">label_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vi_pred_made</span> <span class="o">=</span> <span class="kc">None</span>

        
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/KL_plot_data.h5&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/KL_plot_data.h5&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">])</span>
                <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/KL_plot_data.h5&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;plotting_data_</span><span class="si">%s</span><span class="s1">/KL_plot_data.h5&#39;</span> <span class="o">%</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
       
        <span class="c1"># 4 pannel KL approach</span>
        <span class="n">fig_kl</span><span class="p">,</span> <span class="n">axis_kl</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">usesamps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">print_cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">label_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tmp_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">usesamps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
               <span class="n">kl_idx_1</span> <span class="o">=</span> <span class="mi">0</span>
               <span class="n">kl_idx_2</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="n">kl_idx_1</span> <span class="o">=</span> <span class="mi">1</span>
               <span class="n">kl_idx_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">tot_kl_grey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">usesamps</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tmp_idx</span><span class="p">):</span>

                    <span class="n">sampler1</span><span class="p">,</span> <span class="n">sampler2</span> <span class="o">=</span> <span class="n">samplers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

                    <span class="c1"># Check if sampler results already exists in hf directories</span>
                    <span class="n">h5py_node1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler1</span><span class="p">,</span><span class="n">sampler2</span><span class="p">)</span>
                    <span class="n">h5py_node2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler2</span><span class="p">,</span><span class="n">sampler1</span><span class="p">)</span>
                    <span class="n">node_exists</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">h5py_node1</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">h5py_node2</span> <span class="ow">in</span> <span class="n">hf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">node_exists</span><span class="o">=</span><span class="kc">True</span>

                    <span class="c1"># Get KL results</span>
                    <span class="k">if</span> <span class="n">samplers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span> <span class="c1"># Skip samplers with themselves</span>
                        <span class="n">print_cnt</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">node_exists</span><span class="p">:</span> <span class="c1"># load pre-generated KL results</span>
                        <span class="n">tot_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hf</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler1</span><span class="p">,</span><span class="n">sampler2</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># Make new KL results if needed</span>
                            <span class="k">if</span> <span class="n">sampler1</span> <span class="o">!=</span> <span class="s1">&#39;vitamin&#39;</span><span class="p">:</span>
                                <span class="n">set1</span> <span class="o">=</span> <span class="n">load_samples</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">sampler1</span><span class="p">,</span> <span class="n">pp_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">sampler1</span> <span class="o">==</span> <span class="s1">&#39;vitamin&#39;</span> <span class="ow">and</span> <span class="n">vi_pred_made</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">])))</span>
                                <span class="k">for</span> <span class="n">sig_test_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]):</span>
                                    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gen_samples</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sig_test</span><span class="p">[</span><span class="n">sig_test_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ramp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]))</span> 
                                    <span class="n">set1</span><span class="p">[</span><span class="n">sig_test_idx</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">extract_correct_sample_idx</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">inf_ol_idx</span><span class="p">)</span>
                                <span class="n">vi_pred_made</span> <span class="o">=</span> <span class="p">[</span><span class="n">set1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">sampler2</span> <span class="o">!=</span> <span class="s1">&#39;vitamin&#39;</span><span class="p">:</span>
                                <span class="n">set2</span> <span class="o">=</span> <span class="n">load_samples</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">sampler2</span><span class="p">,</span> <span class="n">pp_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">sampler1</span> <span class="o">==</span> <span class="s1">&#39;vitamin&#39;</span> <span class="ow">and</span> <span class="n">vi_pred_made</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bilby_pars&#39;</span><span class="p">])))</span>
                                <span class="k">for</span> <span class="n">sig_test_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]):</span>
                                    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">gen_samples</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sig_test</span><span class="p">[</span><span class="n">sig_test_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ramp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsamples</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;n_samples&#39;</span><span class="p">]))</span>
                                    <span class="n">set2</span><span class="p">[</span><span class="n">sig_test_idx</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">extract_correct_sample_idx</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">inf_ol_idx</span><span class="p">)</span>
                                <span class="n">vi_pred_made</span> <span class="o">=</span> <span class="p">[</span><span class="n">set2</span><span class="p">]</span>

                        <span class="c1"># Iterate over test cases</span>
                        <span class="n">tot_kl</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># total KL over all infered parameters</span>

                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]):</span>
                            <span class="n">tot_kl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compute_kl</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">set2</span><span class="p">[</span><span class="n">r</span><span class="p">],[</span><span class="n">sampler1</span><span class="p">,</span><span class="n">sampler2</span><span class="p">]))</span>
                            <span class="nb">print</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Completed KL for set </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1"> and test sample </span><span class="si">%s</span><span class="s1"> with mean KL: </span><span class="si">%.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler1</span><span class="p">,</span><span class="n">sampler2</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tot_kl</span><span class="p">)))</span>
                            <span class="nb">print</span><span class="p">()</span>
                        <span class="n">tot_kl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tot_kl</span><span class="p">)</span>

                    <span class="c1"># Try saving both sampler permutations of the KL results</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># Save results to h5py file</span>
                            <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler1</span><span class="p">,</span><span class="n">sampler2</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">tot_kl</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="c1">#                        print(e)</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;load_plot_data&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># Save results to h5py file</span>
                            <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sampler2</span><span class="p">,</span><span class="n">sampler1</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">tot_kl</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="c1">#                        print(e)</span>
                        <span class="k">pass</span>

                    <span class="n">logbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
                    <span class="n">logbins_indi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>

                    <span class="c1"># plot colored hist</span>
                    <span class="k">if</span> <span class="n">samplers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vitamin&#39;</span> <span class="ow">and</span> <span class="n">samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">samplers</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tot_kl</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">logbins</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">CB_color_cycle</span><span class="p">[</span><span class="n">print_cnt</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mathrm{</span><span class="si">%s</span><span class="s1"> \ vs. \ </span><span class="si">%s</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fig_samplers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fig_samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tot_kl</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">logbins</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">CB_color_cycle</span><span class="p">[</span><span class="n">print_cnt</span><span class="p">],</span><span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="c1"># record non-colored hists</span>
                    <span class="k">elif</span> <span class="n">samplers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;vitamin&#39;</span> <span class="ow">and</span> <span class="n">samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;vitamin&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">samplers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">samplers</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="n">samplers</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">samplers</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">]:</span>

                            <span class="n">tot_kl_grey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot_kl_grey</span><span class="p">,</span><span class="n">tot_kl</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">()</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Grey Mean total KL between </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">sampler1</span><span class="p">,</span> <span class="n">sampler2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tot_kl</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
<span class="c1">#                    print(&#39;... Completed KL calculation %d/%d&#39; % (print_cnt,factorial(4)))</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="n">print_cnt</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">tmp_idx</span><span class="o">-=</span><span class="mi">1</span>
            <span class="c1"># Plot non-colored histograms</span>
<span class="c1">#            axis_kl[kl_idx_1,kl_idx_2].hist(np.array(tot_kl_grey).squeeze(),bins=logbins,alpha=0.8,histtype=&#39;stepfilled&#39;,density=True,color=&#39;grey&#39;,label=r&#39;$\mathrm{%s \ vs. \ other \ samplers}$&#39; % fig_samplers[1:][k],zorder=1)</span>
<span class="c1">#            axis_kl[kl_idx_1,kl_idx_2].hist(np.array(tot_kl_grey).squeeze(),bins=logbins,histtype=&#39;step&#39;,density=True,facecolor=&#39;None&#39;,ls=&#39;-&#39;,lw=2,edgecolor=&#39;grey&#39;,zorder=1)</span>

            <span class="n">grey_colors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;#00FFFF&#39;</span><span class="p">,</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="s1">&#39;#800000&#39;</span><span class="p">]</span>
            <span class="c1"># make segmented grey histograms for Chris and I</span>
            <span class="n">grey_cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">sampler_grey</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;samplers&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])):</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">grey_cnt</span><span class="o">*</span><span class="mi">125</span><span class="p">;</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">grey_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">125</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span>
                <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tot_kl_grey</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="n">logbins</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">grey_colors</span><span class="p">[</span><span class="n">sampler_grey</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mathrm{</span><span class="si">%s</span><span class="s1"> \ vs. \ other \ samplers}$&#39;</span> <span class="o">%</span> <span class="n">fig_samplers</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">k</span><span class="p">],</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tot_kl_grey</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="n">logbins</span><span class="p">,</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">grey_cnt</span><span class="o">+=</span><span class="mi">1</span>

            <span class="c1"># plot KL histograms</span>
            <span class="k">if</span> <span class="n">kl_idx_1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathrm{KL-Statistic}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kl_idx_2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$p(\mathrm</span><span class="si">{KL}</span><span class="s1">)$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
           <span class="c1"># axis_kl[kl_idx_1,kl_idx_2].tick_params(axis=&quot;both&quot;, labelsize=12, direction=&#39;out&#39;)</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>  <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#&#39;medium&#39;)</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="c1">#axis_kl[kl_idx_1,kl_idx_2].xaxis.set_minor_locator(FixedLocator([0.5, 1.5, 2.5, 3.5, 4.5]))</span>
            <span class="c1">#axis_kl[kl_idx_1,kl_idx_2].xaxis.set_major_locator(ticker.LogLocator(base=10.0, numticks=15))</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="c1">##axis_kl[kl_idx_1,kl_idx_2].set_xticks(AutoMinorLocator(),minor=True)</span>
            <span class="c1">#caxis_kl[kl_idx_1,kl_idx_2].xaxis.set_minor_locator(MultipleLocator(5))</span>
            <span class="c1">#axis_kl[kl_idx_1,kl_idx_2].tick_params(which=&#39;minor&#39;, length=4, color=&#39;r&#39;)</span>
            <span class="c1">#axis_kl[kl_idx_1,kl_idx_2].set_ylim(top=1.0)</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">locmin</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.9</span><span class="p">),</span><span class="n">numticks</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">locmin</span><span class="p">)</span>
            <span class="n">locmaj</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">numticks</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locmaj</span><span class="p">)</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">axis_kl</span><span class="p">[</span><span class="n">kl_idx_1</span><span class="p">,</span><span class="n">kl_idx_2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Made hist plot </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Save figure</span>
        <span class="n">fig_kl</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="c1">#plt.minorticks_on()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig_kl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/hist-kl.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">360</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_kl</span><span class="p">)</span>
        <span class="n">hf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Saved KL plot to -&gt; </span><span class="si">%s</span><span class="s1">/latest_</span><span class="si">%s</span><span class="s1">/hist-kl.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;plot_dir&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_label&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">return</span> </div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Joseph Bayley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>